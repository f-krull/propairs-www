<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="shortcut icon" href="css/propairs_logo_fav.ico">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<script type="text/javascript" src="js/tabulator.min.js"></script>
<script type="text/javascript" src="js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="css/bootstrap.min.css" type="text/css"/>
<link rel="stylesheet" href="css/tabulator.min.css" type="text/css"/>
<link rel="stylesheet" href="css/pp.css" type="text/css"/>
<script type="text/javascript" src="js/pp_helper.js"></script>
<script type="text/javascript" src="js/pp_layout.js"></script>
<style>
  #table {
    background-color:#fff;
    /* border: 1px solid #333; */
    border-radius: 10px;
  }
  #table .tabulator-header {
    /* background-color:#333; */
    /* color:#fff; */
    /* font-style: italic; */
    font-weight: bold;
    color: rgb(0, 0, 0);
    font-size: 12px;
  }

  :root {
    --color-u1: #c9d4fd;
    --color-u2: #BBFFBB;
    --color-u1d: #bdc8f3;
    --color-u2d: rgb(172, 240, 172);
    --color-u1dd: #a6b0d8;
    --color-u2dd: rgb(146, 206, 146);
  }
  .tabulator .tabulator-header .tabulator-col {
    border-right: 0px;
  }
  /* .tabulator-row {} */
  .tabulator-row .tabulator-cell {
    border-right: 0px;
    font-weight: bold;
    color: #444;
    font-size: 12px;
  }
  .tabulator-row:hover {
    font-weight: bold;
  }
  .tabulator-row-odd .pp-u1 {
    background-color: var(--color-u1);
  }
  .tabulator-row-odd .pp-u2 {
    background-color: var(--color-u2);
  }
  .tabulator-row-even .pp-u1 {
    background-color: var(--color-u1d);
  }
  .tabulator-row-even .pp-u2 {
    background-color: var(--color-u2d);
  }
  .tabulator-row-odd:hover .pp-u1 {
    background-color: var(--color-u1dd);
  }
  .tabulator-row-odd:hover .pp-u2 {
    background-color: var(--color-u2dd);
  }
  .tabulator-row-even:hover .pp-u1 {
    background-color: var(--color-u1dd);
  }
  .tabulator-row-even:hover .pp-u2 {
    background-color: var(--color-u2dd);
  }
  .tabulator-row .pp-open {
    padding: 0px;
  }
  .tabulator-row:hover .pp-open span img {
    border: 3px solid rgb(180, 180, 180) !important;
  }


  #btnFilterOpen::before {
    width: 1.25em;
    line-height: 0;
    content: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='rgba%280,0,0,.5%29' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5 14l6-6-6-6'/%3e%3c/svg%3e");
    transition: transform .35s ease;
    transform-origin: .5em 50%;
  }

  #btnFilterOpen[aria-expanded="true"]::before {
    transform: rotate(90deg)/* rtl:ignore */;
  }


</style>
</head>
<body>
  <script>pplayout.init();</script>
  <header id="pp-nav" class="mb-auto"></header><script>pplayout.nav();</script>
  <div class="container">
    <h2 class="py-lg-3">Non-redundant ProPairs data set</h2>
    <div class="row">
      <div class="col">
        <p>
          In this non-redundant dataset, we report only one interface whenever ProPairs found similar ones. 
          Also in this data set, we report one unbound structure (if available) for each binding partner; 
          but more might have been identified by ProPairs. If you are interested to see similar interfaces or 
          similar unbound structures, please open the <i>details</i> page of any complex below and follow its links.
        </p>
        <p>
          The complete set of PDB structures of both binding partners with bound an unbound state superposed can be downloaded <a href="dl_pdb.html">here</a>.
        </p>
      </div>

      <div class="col-md-3 form-group mb-3">
        <label for="sel-set-id" class="form-label">Data set version:</label>
        <select id="sel-set-id" class="form-control" name="set-id" disabled></select>
      </div>
    </div>

    <div id="filter">
      <button id="btnFilterOpen" class="btn btn-outline-primary d-inline-flex align-items-center mb-1" data-bs-toggle="collapse" aria-controls="filter-collapse" aria-expanded="false" data-bs-target="#filter-collapse">Filter</button>
      <span id="filterStatus" class="ms-3"></span>
      <div class="px-3 collapse hide" id="filter-collapse">
        <hr>
        <div class="row mb-1">
          <label for="filterCaMin" class="col-md-2 col-form-label col-form-label-md">Num. interface-Cα:</label>
          <div class="col-md-2 mb-1">
            <div class="input-group input-group-sm">
              <div class="input-group-text">min</div>
              <input type="number" class="form-control form-control-sm" id="filterCaMin">
            </div>
          </div>
          <div class="col-md-2 mb-1">
            <div class="input-group input-group-sm">
              <div class="input-group-text">max</div>
              <input type="number" class="form-control form-control-sm" id="filterCaMax">
            </div>
          </div>
          <label for="filterS2Min" class="col-md-2 col-form-label col-form-label-md">Num. S2-bonds:</label>
          <div class="col-md-2 mb-1">
            <div class="input-group input-group-sm">
              <div class="input-group-text">min</div>
              <input type="number" class="form-control form-control-sm" id="filterS2Min">
            </div>
          </div>
          <div class="col-md-2 mb-1">
            <div class="input-group input-group-sm">
              <div class="input-group-text">max</div>
              <input type="number" class="form-control form-control-sm" id="filterS2Max">
            </div>
          </div>          
        </div>
        <div class="row mb-1">
          <label for="filterSimMin" class="col-md-2 col-form-label col-form-label-md">Interface similarity (%):</label>
          <div class="col-md-2">
            <div class="input-group input-group-sm">
              <div class="input-group-text">min</div>
              <input type="number" class="form-control form-control-sm" id="filterSimMin">
            </div>
          </div>
          <div class="col-md-2 mb-1">
            <div class="input-group input-group-sm">
              <div class="input-group-text">max</div>
              <input type="number" class="form-control form-control-sm" id="filterSimMax">
            </div>
          </div>
          <label for="filterRmsdMin" class="col-md-2 col-form-label col-form-label-md">Interface-RMSD (Å):</label>
          <div class="col-md-2 mb-1">
            <div class="input-group input-group-sm">
              <div class="input-group-text">min</div>
              <input type="number" step="0.01" class="form-control form-control-sm" id="filterRmsdMin">
            </div>
          </div>
          <div class="col-md-2 mb-1">
            <div class="input-group input-group-sm">
              <div class="input-group-text">max</div>
              <input type="number" step="0.01" class="form-control form-control-sm" id="filterRmsdMax">
            </div>
          </div>          
        </div>
        <div class="row mb-3">
          <label for="filterRangeScope" class="col-lg-2 col-form-label col-form-label-md">Apply ranges to:</label>
          <div class="col-lg-3 mb-1">
            <select id="filterRangeScope" class="form-select form-select-sm">
              <option value="1">at least one binding partner</option>
              <option value="2">both binding partners</option>
            </select>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-3 mb-1">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="filterNmr" checked>
              <label class="form-check-label" for="filterNmr">Include NMR structures</label>
            </div>
          </div>
          <div class="col-md-3 mb-1">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="filterMissingU">
              <label class="form-check-label" for="filterMissingU">Include missing unbound</label>
            </div>
          </div>
          <div class="col-md-3 mb-1">
            <select class="form-select form-select-sm" id="filterCof">
              <option value="0">exclude cofactors</option>
              <option value="1">allow cofactors</option>
              <option value="2">require cofactors</option>
            </select>
          </div>
          <div class="col-md-3 mb-1">
            <input id="filterKeyword" class="form-control form-select-sm" list="filterKeywordOptions" placeholder="Keyword - Type to search...">
            <datalist id="filterKeywordOptions">
            </datalist>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-2 mb-1 d-grid gap-2">
            <button id="btnReset" class="btn btn-sm btn-outline-secondary">Reset</button>
          </div>
          <div class="col-md-2 mb-1 d-grid gap-2">
            <button id="btnApply" class="btn btn-sm btn-secondary">Apply</button>
          </div>
        </div>
        <hr>
      </div>
    </div>
  


    <button id="btnDlCsv" class="mt-3 btn btn-secondary">Download CSV</button>
    <div id="table" class="mt-3"></div>
  </div>
  <footer id="pp-footer"></footer><script>pplayout.footer();</script>
  <script>

    var rows_jsn;
    var table;

    var filterRanges = {
      num_ca: {
        min: NaN,
        max: NaN,
      },
      num_s2: {
        min: NaN,
        max: NaN,
      },
      apply_ranges_to: 1,
      include_nmr: true,
      include_missing_unbound: false,
      keyword: "",
    };

    function resetFilter(apply = true) {
      const num_ca = rows_jsn.map(e => parseInt(e.bNumCa)).filter(e => !isNaN(e));
      document.getElementById("filterCaMin").value = Math.min.apply(null, num_ca);
      document.getElementById("filterCaMax").value = Math.max.apply(null, num_ca);
      const num_s2 = rows_jsn.map(e => parseInt(e.bNumS2)).filter(e => !isNaN(e));
      document.getElementById("filterS2Min").value = Math.min.apply(null, num_s2);
      document.getElementById("filterS2Max").value = Math.max.apply(null, num_s2);
      const int_sim1 = rows_jsn.map(e => parseFloat(e.u1Sim)).filter(e => !isNaN(e));
      const int_sim2 = rows_jsn.map(e => parseFloat(e.u2Sim)).filter(e => !isNaN(e));
      document.getElementById("filterSimMin").value = Math.round(Math.min.apply(null, int_sim1.concat(int_sim2))*100);
      document.getElementById("filterSimMax").value = Math.round(Math.max.apply(null, int_sim1.concat(int_sim2))*100);
      const int_rmsd1 = rows_jsn.map(e => parseFloat(e.u1Rmsd)).filter(e => !isNaN(e));
      const int_rmsd2 = rows_jsn.map(e => parseFloat(e.u2Rmsd)).filter(e => !isNaN(e));
      document.getElementById("filterRmsdMin").value = Math.min.apply(null, int_rmsd1.concat(int_rmsd2));
      document.getElementById("filterRmsdMax").value = Math.max.apply(null, int_rmsd1.concat(int_rmsd2));
      document.getElementById("filterRangeScope").value=1;
      document.getElementById("filterNmr").checked = true;
      document.getElementById("filterMissingU").checked = false;
      document.getElementById("filterCof").value = 1;
      document.getElementById("filterKeyword").value = "";
      if (apply) applyFilter();
    }

    

    function applyFilter() {
      const fc = {
        num_ca: {
          min: parseInt(document.getElementById("filterCaMin").value),
          max: parseInt(document.getElementById("filterCaMax").value),
        },
        num_s2: {
          min: parseInt(document.getElementById("filterS2Min").value),
          max: parseInt(document.getElementById("filterS2Max").value),
        },
        sim: {
          min: parseFloat(document.getElementById("filterSimMin").value)/100,
          max: parseFloat(document.getElementById("filterSimMax").value)/100,
        },
        rmds: {
          min: parseFloat(document.getElementById("filterRmsdMin").value),
          max: parseFloat(document.getElementById("filterRmsdMax").value),
        },
        apply_ranges_to: document.getElementById("filterRangeScope").value,
        include_nmr: document.getElementById("filterNmr").checked,
        include_missing_unbound: document.getElementById("filterMissingU").checked,
        cof: document.getElementById("filterCof").value,
        keyword: document.getElementById("filterKeyword").value,
      };
      let rangefunc = fc.apply_ranges_to == "1" ? (a,b) => (a || b) : (a,b) => (a && b);
      let coffunc = (function(v){
        if (v == 0) return (bCof) => bCof.length == 0;
        if (v == 1) return (bCof) => true;
        if (v == 2) return (bCof) => bCof.length > 0;
        throw "coffunc";
      })(document.getElementById("filterCof").value);
      let rf = rows_jsn
        .filter(e => (fc.num_ca.min <= parseFloat(e.bNumCa) && parseFloat(e.bNumCa) <= fc.num_ca.max))
        .filter(e => (e.bNumS2 === undefined) || (fc.num_s2.min <= parseFloat(e.bNumS2) && parseFloat(e.bNumS2) <= fc.num_s2.max))
        .filter(e => rangefunc(
            (fc.sim.min <= parseFloat(e.u1Sim) && parseFloat(e.u1Sim) <= fc.sim.max),
            (fc.sim.min <= parseFloat(e.u2Sim) && parseFloat(e.u2Sim) <= fc.sim.max),
          ))
        .filter(e => rangefunc(
          (fc.rmds.min <= parseFloat(e.u1Rmsd) && parseFloat(e.u1Rmsd) <= fc.rmds.max),
          (fc.rmds.min <= parseFloat(e.u2Rmsd) && parseFloat(e.u2Rmsd) <= fc.rmds.max),
        ))
        .filter(e => fc.include_nmr || (e.u1Name.charAt(4).match(/[0-9]/) && (e.u2Name.charAt(0) == "-" || e.u2Name.charAt(4).match(/[0-9]/))))
        .filter(e => fc.include_missing_unbound || (e.u2Name.charAt(0) != "-"))
        .filter(e => e.bType.toLowerCase().includes(fc.keyword.toLowerCase()))
        .filter(e => coffunc(e.bCof))
        ;
      document.getElementById("filterStatus").innerHTML = `${rf.length} / ${rows_jsn.length} displayed`;
      table.replaceData(rf);
    }


    async function updateSelSetIds() {
      const url_params = new URLSearchParams(window.location.search);
      const curr_set = url_params.get("set");
      var es = document.getElementById("sel-set-id");
      (await pp.getSetIds()).forEach(e => {
        var eo = document.createElement("option");
        eo.value = e;
        eo.innerHTML = e;
        eo.selected = e == curr_set;
        es.appendChild(eo)
      });
      es.disabled = false;
      es.onchange = function() {
        var searchParams = new URLSearchParams(window.location.search);
        searchParams.set("set", getSelSetId());
        window.location.search = searchParams.toString();
      };
    }

    function getSelSetId() {
      return document.getElementById("sel-set-id").value;
    }

    function progressInit(parentId) {
      var ep = document.getElementById(parentId);
      let es = document.createElement("div");
      ep.appendChild(es);
      es.id = "pp-progress-text";
      es.classList.add("progress");
      let e = document.createElement("div");
      es.appendChild(e);
      e.id = "pp-progress";
      e.classList.add("progress-bar");
      e.style.width = "0%";
    }
    function progressSet(p) {
      var e = document.getElementById("pp-progress");
      e.style.width = `${p*100}%`;
      e.innerHTML = `${(p*100).toFixed(2)}%`;
    }

    function _getSimFmt(cell) {
      const val = Math.round(parseFloat(cell.getValue()) * 100);
      return val ? `${val}%` : "-";
    }

    function _getPdbFmt(c,_,__){
      return `${c.getValue().slice(0, 4)}${c.getValue().slice(5)}`;
    }




    (async function(){
      pp.progressInit("table", null);

      await updateSelSetIds();
      const set_descr = await pp.getSetDescription(getSelSetId());

      rows_jsn = await (async function(){
        const data_url = `./data/${getSelSetId()}/propairs_set_${getSelSetId()}_paired_representative.json`;
        const r = await fetch(data_url, {
          method: "GET"
        });
      
        return Object.entries(await r.json()).map(([k,v]) => {
          v.id = k;
          return v;
        });
      })();

      // fix u2 cofactors; has "-" if NA
      rows_jsn = rows_jsn.map((e) => {
        e.u2Cof = e.u2Cof.filter(e => e != "-");
        return e;
      });

      {
        const kw = [...new Set(rows_jsn.map(
        e => e.bType
          .replace(/[^A-Za-z0-9]/g," ")
          .split(/\s+/)
          .filter(e => e.length >= 3)
          .filter(e => e != "")
        ).flat())];
        let ekw = document.getElementById("filterKeywordOptions");
        ekw.innerHTML = "";
        for (let [key, value] of kw.entries()) {
          let eo = document.createElement("option");
          eo.value = value.toLowerCase();
          ekw.appendChild(eo);
        }
      }

      resetFilter(false);
      

      const wdMaxCof = 140;
      const wdMaxPDb = 120;
      const wdMaxNum = 80;

      table = new Tabulator("#table", {
        height: "811px",
        layout: "fitColumns",
        // data: rows_jsn,
        pagination: "local",
        tooltips: true,
        tooltipsHeader: true,
        rowClick:function(e, row){
          window.open(`./nr_detail.html?set=${set_descr.id}&id=${row.getData().id}`, '_blank');
        },
        columns: [
          { field:"id",     title:"",                  width: 80, formatter: (cell,_,onR) => {
            onR(() => cell.getElement().classList.add("pp-open"));
            var es = document.createElement("span");
            {
              var eimg = document.createElement("img");
              es.appendChild(eimg);
              eimg.src = `./data/${set_descr.id}/info/${cell.getData().id}/preview.png`;
              eimg.width = 26;
              eimg.height = 26;
              eimg.style = "background-color: white;"
              eimg.style = "background-color: white; border: 3px solid white"
              var ea = document.createElement("a");
              es.appendChild(ea); 
              ea.style = "padding: 4px;"
              ea.innerHTML = "details";
              ea.href = `#`;
            }
            return es;

          }},
          { field:"bName",  title:"complex PDB",       width: 120, formatter: _getPdbFmt },
          { field:"bType",  title:"complex type", },
          { field:"bNumCa", title:"#intf.-Cα",         width: 85, },
          { field:"bNumS2", title:"S2 bonds",          width: 88, },
          { field:"bCof",   title:"complex cofactors", maxWidth: wdMaxCof },
          { field:"u1Name", title:"u1 PDB", width: 80, formatter: (cell, _, onR) => {
              onR(() => cell.getElement().classList.add("pp-u1"));
              return _getPdbFmt(cell,_,onR);
            }
          },
          { field:"u1Sim",  title:"u1 sim.", maxWidth: wdMaxNum, formatter: (cell, _, onR) => {
              onR(() => cell.getElement().classList.add("pp-u1"));
              return _getSimFmt(cell);
            }
          },
          { field:"u1Cof",  title:"u1 cofactors", width: 120 , formatter: (cell, _, onR) => {
              onR(() => cell.getElement().classList.add("pp-u1"));
              return cell.getValue().join(",");
            }
          },
          { field:"u1Rmsd", title:"u1 iRMSD", maxWidth: wdMaxNum, formatter: (cell, _, onR) => {
              onR(() => cell.getElement().classList.add("pp-u1"));
              return cell.getValue();
            }
          },
          { field:"u2Name", title:"u2 PDB", width: 80, formatter: (cell, _, onR) => {
              onR(() => cell.getElement().classList.add("pp-u2"));
              return _getPdbFmt(cell,_,onR);
            }
          },
          { field:"u2Sim",  title:"u2 sim.", maxWidth: wdMaxNum, formatter: (cell, _, onR) => {
              onR(() => cell.getElement().classList.add("pp-u2"));
              return _getSimFmt(cell);
            }
          },
          { field:"u2Cof",  title:"u2 cofactors", width: 120 , formatter: (cell, _, onR) => {
              onR(() => cell.getElement().classList.add("pp-u2"));
              return cell.getValue().join(",");
            }
          },
          { field:"u2Rmsd", title:"u2 iRMSD", maxWidth: wdMaxNum, formatter: (cell, _, onR) => {
              onR(() => cell.getElement().classList.add("pp-u2"));
              return cell.getValue();
            }
          },
        ]
      });
      applyFilter();


      document.getElementById("filterCaMin").oninput = applyFilter;
      document.getElementById("filterCaMax").oninput = applyFilter;
      document.getElementById("filterS2Min").oninput = applyFilter;
      document.getElementById("filterS2Max").oninput = applyFilter;
      document.getElementById("filterSimMin").oninput = applyFilter;
      document.getElementById("filterSimMax").oninput = applyFilter;
      document.getElementById("filterRmsdMin").oninput = applyFilter;
      document.getElementById("filterRmsdMax").oninput = applyFilter;
      document.getElementById("filterRangeScope").oninput = applyFilter;
      document.getElementById("filterNmr").oninput = applyFilter;
      document.getElementById("filterMissingU").oninput = applyFilter;
      document.getElementById("filterCof").oninput = applyFilter;
      document.getElementById("filterKeyword").oninput = applyFilter;

      document.getElementById("btnDlCsv").onclick = () => table.download("csv", `propairs_set_${set_descr.id}_paired_representative.csv`);
      document.getElementById("btnReset").onclick = resetFilter;


    })();
  </script>
</body>
</html>

